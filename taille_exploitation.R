# donnees taille exploitation https://stats.agriculture.gouv.fr/cartostat/#l=fr;i=stru1.saumoydiff;v=map1

taille_exp<-read.csv2("taille_exploitation.csv", header=T)
taille_exp$SAU_var_abs<-as.numeric(as.character(taille_exp$SAU_var_abs))
taille_exp$SAU<-as.numeric(as.character(taille_exp$SAU))
taille_exp$SAU_var_rel<-as.numeric(as.character(taille_exp$SAU_var_rel))

# donnees geographique des cantons ici : https://public.opendatasoft.com/explore/dataset/correspondance-code-insee-code-postal/export/


library(tidyr)
code_postal<-read.csv2("correspondance-code-insee-code-postal.csv", header=TRUE)
code_postal<-separate(code_postal,"geo_point_2d",c("lat","lon"),sep = ",")

clean<-function(x){
  x_cleaned<-gsub('{"type": "Polygon", "coordinates": [[','',x, fixed = TRUE)
  x_cleaned<-gsub('{\"type\": \"MultiPolygon\", \"coordinates\": [[','',x_cleaned, fixed = TRUE)
  x_cleaned<-gsub(']]}','',x_cleaned, fixed = TRUE)
  return(x_cleaned)
} 

code_postal$geo_shape<-sapply(code_postal$geo_shape,clean)
code_postal<-separate(code_postal,"geo_shape",into=paste(rep("C",486), sep = "_", c(1:486)),sep = "],")
code_postal2<-melt(code_postal, id.vars = names(code_postal)[c(1:11,498:503)])
code_postal2<-na.omit(code_postal2)
code_postal2$variable<-NULL
code_postal2$poly<-sapply(code_postal2$value,FUN=function(x){gsub('[','',x, fixed = TRUE)})
code_postal2$poly<-sapply(code_postal2$poly,FUN=function(x){gsub(']','',x, fixed = TRUE)})
code_postal2$value<-NULL
code_postal2<-separate(code_postal2,"poly",c("lon_poly","lat_poly"),sep = ", ")
code_postal2$lat<-as.numeric(code_postal2$lat)
code_postal2$lon<-as.numeric(code_postal2$lon)
code_postal2$lat_poly<-as.numeric(code_postal2$lat_poly)
code_postal2$lon_poly<-as.numeric(code_postal2$lon_poly)
#commune_multi<-code_postal2$Code.Commune[which(is.na(code_postal2$lon_poly))]
#code_postal2<-code_postal2[!(code_postal2$Code.Commune %in% commune_multi),]
code_postal2$Altitude.Moyenne<-as.numeric(as.character(code_postal2$Altitude.Moyenne))
code_postal2$Superficie<-as.numeric(as.character(code_postal2$Superficie))
code_postal2$Population<-as.numeric(as.character(code_postal2$Population))

a<-droplevels(code_postal2[code_postal2$lat>40,])
a$Commune_unique<-paste0(a$Commune, sep="_", a$Code.Postal, sep="_", a$Code.Commune)
a2<-lapply(split(a[,c(18:19)], a$Commune_unique), Polygon)
a2<-SpatialPolygons(lapply(seq_along(a2),function(i){Polygons(list(a2[[i]]),ID=row.names(a[!duplicated(a$Commune_unique),])[i])}))
aa<-a %>% group_by(Code.Postal, Code.INSEE, Commune, Code.Commune) %>% summarize(count=n()) %>% data.frame()
aa$Commune_unique<-as.factor(paste0(aa$Commune, sep="_", aa$Code.Postal, sep="_", aa$Code.Commune))
aa$dep<-a$Code.DÃ©partement[match(aa$Commune_unique,a$Commune_unique)]
aa2<-aa[order(aa$Commune_unique),]
a5<-gBuffer(a2, byid=TRUE, width=0)
a4<-unionSpatialPolygons(a5,aa2[,1])
proj4string(a4)<-CRS("+proj=longlat +ellps=WGS84")
proj4string(a2)<-CRS("+proj=longlat +ellps=WGS84")

# par code postal
corresp_insee<-data.frame(code_insee=unique(a[,c("Code.INSEE")]))
corresp_insee$code_postal<-a$Code.Postal[match(corresp_insee$code_insee,a$Code.INSEE)]
taille_exp2 <- merge(corresp_insee,taille_exp,by.x="code_insee",by.y="Code", all.x=T)
taille_exp2 <- data.frame(taille_exp2 %>% group_by(code_postal) %>% summarize(SAU_m=mean(SAU, na.rm=T),
                                                                   SAU_va=mean(SAU_var_abs, na.rm=T),
                                                                   SAU_vr=mean(SAU_var_rel, na.rm=T)))
row.names(taille_exp2)<-taille_exp2$code_postal

a6<-SpatialPolygonsDataFrame(a4,data = taille_exp2)
map<-a6
map.data <- data.frame(id=rownames(map@data), map@data)
map.df   <- fortify(map)
map.df   <- merge(map.df,map.data,by="id")
ggplot(map.df, aes(x=long, y=lat, group=group))+
  geom_polygon(aes(fill=SAU_m))+
  scale_fill_viridis(alpha = 1, begin = 0, end = 1, direction = 1, option = "B") +
  theme(axis.text=element_blank())+
  theme_minimal()+
  coord_fixed(1.3)

ggplot(map.df, aes(x=long, y=lat, group=group))+
  geom_polygon(aes(fill=SAU_va))+
  scale_fill_gradient2(low="#800080",mid="#F7F7F7",high="#FFC100", midpoint=0, limits=c(-100,150)) +
  theme(axis.text=element_blank())+
  theme_minimal()+
  coord_fixed(1.3)

# par code insee
corresp_insee<-data.frame(code_insee=unique(a[,c("Code.INSEE")]))
corresp_insee$code_postal<-a$Code.Postal[match(corresp_insee$code_insee,a$Code.INSEE)]
taille_exp3 <- merge(corresp_insee,taille_exp,by.x="code_insee",by.y="Code", all.x=T)
rown<-data.frame(code_insee=aa2$Code.INSEE,num=1:nrow(aa2))
taille_exp3 <- merge(taille_exp3,rown,by="code_insee", all.x=T)
taille_exp3<-taille_exp3[order(taille_exp3$num),]
row.names(taille_exp3)<-taille_exp3$num
row.names(taille_exp3)<-new_IDs

new_IDs = paste0("ID", 1:length(a2))
for (i in 1:length(slot(a2, "polygons"))){
  print(i)
  slot(slot(a2, "polygons")[[i]], "ID") = new_IDs[i]
}

a6<-SpatialPolygonsDataFrame(a2,data = taille_exp3)
map<-a6
map.data <- data.frame(id=rownames(map@data), map@data)
map.df   <- fortify(map)
map.df   <- merge(map.df,map.data,by="id")
ggplot(map.df, aes(x=long, y=lat, group=group))+
  geom_polygon(aes(fill=SAU))+
  scale_fill_viridis(alpha = 1, begin = 0, end = 1, direction = 1, option = "B") +
  theme(axis.text=element_blank())+
  theme_minimal()+
  coord_fixed(1.3)

##

carre_sp_point<-SpatialPoints(carre_centroid2[,2:3])
proj4string(carre_sp_point)<- CRS("+proj=longlat +ellps=WGS84")
taille_exp4<-over(carre_sp_point, a6)
taille_exp4$long<-carre_centroid2$long
taille_exp4$lat<-carre_centroid2$lat
taille_exp4$code_carre<-carre_centroid2$code_carre
taille_exp4$lon2<-carre_centroid2$lon2
taille_exp4$lat2<-carre_centroid2$lat2

taille_exp4<-merge(taille_exp4[,c("code_carre","SAU_m","SAU_va","SAU_vr")], carre_centroid2, by="code_carre", all.x=T)

ggplot(taille_exp4, aes(x=lon2, y=lat2))+
  geom_tile(aes(fill=SAU_m),width=2000,height=2000)+
  scale_fill_viridis(alpha = 1, begin = 0, end = 1, direction = 1, option = "B") +
  theme_void()+theme(legend.position="bottom")+
  coord_equal()+borders(border_fr3)

ggplot(taille_exp4, aes(x=lon2, y=lat2))+
  geom_tile(aes(fill=SAU_va),width=2000,height=2000)+
  scale_fill_gradient2(low="#800080",mid="#F7F7F7",high="#FFC100", midpoint=0, limits=c(-100,100)) +
  theme_void()+theme(legend.position="bottom")+
  coord_equal()+borders(border_fr3)

ggplot(taille_exp4, aes(x=lon2, y=lat2))+
  geom_tile(aes(fill=SAU_vr),width=2000,height=2000)+
  scale_fill_gradient2(low="#800080",mid="#F7F7F7",high="#FFC100", midpoint=0, limits=c(-100,100)) +
  theme_void()+theme(legend.position="bottom")+
  coord_equal()+borders(border_fr3)

ggsave(
  "taille_exp.png",
  width = 10,
  height = 10,
  dpi = 1200
)
